# üõ°Ô∏è Rate Limiting Setup Guide

## –ß—Ç–æ —ç—Ç–æ?

Rate limiting –∑–∞—â–∏—â–∞–µ—Ç —Ç–≤–æ–π API –æ—Ç —Å–ø–∞–º–∞ –∏ DDoS –∞—Ç–∞–∫. –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç –æ–¥–Ω–æ–≥–æ IP/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ

1. ‚úÖ –°–æ–∑–¥–∞–Ω `lib/ratelimit.js` - middleware —Å graceful fallback
2. ‚úÖ –ï—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∞–ø–ø–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ (–±–µ–∑ –∑–∞—â–∏—Ç—ã)
3. ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ—à–∏–±–æ–∫

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã

```bash
npm install @upstash/ratelimit @upstash/redis
```

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å Upstash Redis

1. –ó–∞–π–¥–∏ –Ω–∞ https://upstash.com (–±–µ—Å–ø–ª–∞—Ç–Ω–æ!)
2. –°–æ–∑–¥–∞–π –∞–∫–∫–∞—É–Ω—Ç (–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ GitHub)
3. –°–æ–∑–¥–∞–π Redis database (–≤—ã–±–µ—Ä–∏ —Ä–µ–≥–∏–æ–Ω –±–ª–∏–∂–µ –∫ —Ç–≤–æ–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
4. –°–∫–æ–ø–∏—Ä—É–π:
   - `UPSTASH_REDIS_REST_URL`
   - `UPSTASH_REDIS_REST_TOKEN`

### –®–∞–≥ 3: –î–æ–±–∞–≤–∏—Ç—å –≤ `.env.local`

```env
# Upstash Redis (–¥–ª—è rate limiting)
UPSTASH_REDIS_REST_URL=https://your-redis-url.upstash.io
UPSTASH_REDIS_REST_TOKEN=your-token-here
```

### –®–∞–≥ 4: –î–æ–±–∞–≤–∏—Ç—å –≤ Vercel Environment Variables

1. Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables
2. –î–æ–±–∞–≤—å —Ç–µ –∂–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
3. Redeploy

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –í–∞—Ä–∏–∞–Ω—Ç 1: –û–±–µ—Ä–Ω—É—Ç—å –≤–µ—Å—å handler (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```javascript
// app/api/listings/route.js
import { withRateLimit } from '@/lib/ratelimit';

async function handler(req) {
  // –¢–≤–æ–π –∫–æ–¥
  return new Response(JSON.stringify({ ok: true }));
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–π –æ–±–µ—Ä–Ω—É—Ç—ã–π handler
export const POST = withRateLimit(handler, {
  limit: 5,      // 5 –∑–∞–ø—Ä–æ—Å–æ–≤
  window: '1 m'  // –∑–∞ 1 –º–∏–Ω—É—Ç—É
});
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä—É—á–Ω—É—é

```javascript
// app/api/messages/route.js
import { checkRateLimit, getIdentifier } from '@/lib/ratelimit';

export async function POST(req) {
  const identifier = getIdentifier(req);
  const { success, remaining } = await checkRateLimit(identifier, {
    limit: 10,
    window: '10 s'
  });
  
  if (!success) {
    return new Response('Too many requests', { status: 429 });
  }
  
  // –¢–≤–æ–π –∫–æ–¥
}
```

## üìä –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ª–∏–º–∏—Ç—ã

| Endpoint | –õ–∏–º–∏—Ç | –û–∫–Ω–æ | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|-------|------|---------|
| `/api/listings` (POST) | 5 | 1 –º–∏–Ω—É—Ç–∞ | –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–π |
| `/api/messages` (POST) | 10 | 10 —Å–µ–∫—É–Ω–¥ | –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π |
| `/api/auth/tg/verify` | 10 | 1 –º–∏–Ω—É—Ç–∞ | –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è |
| `/api/translate` | 20 | 1 –º–∏–Ω—É—Ç–∞ | –ü–µ—Ä–µ–≤–æ–¥—ã (–¥–æ—Ä–æ–≥–æ) |
| `/api/geocode` | 10 | 10 —Å–µ–∫—É–Ω–¥ | –ì–µ–æ–∫–æ–¥–∏–Ω–≥ |

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –û—Ç–ø—Ä–∞–≤—å 15 –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–¥—Ä—è–¥
for i in {1..15}; do
  curl -X POST http://localhost:3000/api/listings \
    -H "Content-Type: application/json" \
    -d '{"title":"test"}' && echo ""
done

# –ü–æ—Å–ª–µ 10-–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å—Å—è 429 Too Many Requests
```

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

Upstash Dashboard –ø–æ–∫–∞–∂–µ—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
- –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ IP
- –ì—Ä–∞—Ñ–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

## ‚ö†Ô∏è –í–∞–∂–Ω–æ!

1. **Graceful Degradation**: –ï—Å–ª–∏ Redis —É–ø–∞–¥–µ—Ç, –∞–ø–ø–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å (–±–µ–∑ –∑–∞—â–∏—Ç—ã)
2. **–õ–æ–≥–∏**: –í—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å
3. **–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω**: 10,000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞)
4. **IP Detection**: –†–∞–±–æ—Ç–∞–µ—Ç —Å Vercel, Cloudflare, –∏ –¥—Ä—É–≥–∏–º–∏

## üí∞ –°—Ç–æ–∏–º–æ—Å—Ç—å

- **Free tier**: 10,000 –∫–æ–º–∞–Ω–¥/–¥–µ–Ω—å (–±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞–≤—Å–µ–≥–¥–∞)
- **Pay as you go**: $0.2 –∑–∞ 100,000 –∫–æ–º–∞–Ω–¥
- –î–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ - –±–µ—Å–ø–ª–∞—Ç–Ω–æ!

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–∞–∫–µ—Ç—ã
2. [ ] –°–æ–∑–¥–∞—Ç—å Upstash Redis
3. [ ] –î–æ–±–∞–≤–∏—Ç—å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
4. [ ] –û–±–µ—Ä–Ω—É—Ç—å –∫—Ä–∏—Ç–∏—á–Ω—ã–µ endpoints
5. [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
6. [ ] –ó–∞–¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ Vercel

---

**–í–æ–ø—Ä–æ—Å—ã?** –ü–∏—à–∏ –º–Ω–µ!
